## RPC理解

消费者根据服务接口名，方法，参数，序列化（RpcRequest）后传给在注册中心找到的对应服务网络地址，提供者监听了这个端口，知道有人要调用自己的服务，反序列化后调用自己的服务，将结果（RpcResponse）序列化后返回。这样消费者将拿到了结果。

## Provider

先调用启动类 RpcApplication 进行rpc**框架初始化**，在这里会加载类路径下的配置文件，如果没有的话，就是用rpc默认配置
（name=rpc，version=1.0，serverHost=localhost，serverPort=8081，isMock=false，serializer=kryo，registryConfig=默认配置）

**得到注册中心配置**后，就会调用注册中心工厂的静态方法，在此之前，触发工厂的静态代码块，代码块中使用**spi机制**去记载配置的注册中心。根据传入的类名去匹配配置文件。SpiLoader 有一个静态变量 loadMap 用于存储已加载的类，拿到key对应的全类名后，利用反射去去获取类对象，每个配置对应着一个key，value值为一个map，对应着具体实现。

然后获取对应key的实例并返回。**拿到注册中心实例**后，就会去调用实例的初始方法，拿到 client 和 kvClient。

接下来就是进行**服务注册**了，先在本地进行服务注册，key 为服务接口，value 为服务接口的具体实现类。

再注册服务到注册中心。获取初始化的 rpcConfig，根据这个配置好服务元信息 serviceMetaInfo ，把这个传入到注册中心实例的注册方法中，进行注册。创建 lease 租约，和键值对，key为 "/rpc/服务名称:服务版本号/ 服务地址", value为 服务元信息的json形式，再将两者关联起来。存入到 kvClient，服务到这里就已经注册到注册中心了。

最后**启动web服务**。创建 VertHttpServer 对象，调用其 doStart 方法（这里传入rpc配置的服务端口）。在这里传入了一个自定义的请求处理器 HttpServerHandler 。在这里使用 SPI 机制到序列化器工厂拿到 rpcConfig 中指定的序列化器，处理消费者的请求时，根据参数反射获取到本地注册的服务实现类，根据方法名和参数调用 invoke 方法，封装参数返回。

**总结**：框架初始化 ——》 进行服务注册 ——》启动web服务

## Consumer

先获取想要调用的**服务代理**。这时服务代理就绑定了一个调用处理器ServiceProxy，当调用服务代理的方法时，才去调用处理器的 invoke方法。先加载指定序列化器，构造请求，将请求序列化。加载消费者对 rpc 的配置，再**获取**中注册中心的**默认配置**，根据服务名和rpc的版本号构造服务元信息，再去注册中心**寻找**对于的**服务**，返回一个服务元信息的列表，通过负载均衡获取到一个服务，然后去调用服务，可以重试和容错兜底，返回**调用服务**的结果。

**总结**：获取代理对象 ——》获取注册中心 ——》寻找服务 ——》调用服务

## 项目模块介绍

| 模块                        | 介绍                                                         |
| --------------------------- | ------------------------------------------------------------ |
| rpc-core                    | rpc框架的核心模块，包含全局配置、spi机制、自定义协议、负载均衡等 |
| rpc-easy                    | rpc框架的简易实现                                            |
| example-common              | 消费者和提供者都需要的服务模块                               |
| example-consumer            | 服务消费者模块                                               |
| example-provider            | 服务提供者模块                                               |
| rpc-spring-boot-starter     | 对rpc进行封装，提供注解便于用户使用                          |
| example-springboot-consumer | 消费者注解调用的示例                                         |
| exampe-springboot-provider  | 提供者注解调用的示例                                         |

